services:
  postgres:
    image: postgres:15
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - pgdata:/var/lib/postgresql/data
    networks:
      - tg-network

  flow-service:
    build:
      context: .
      dockerfile: services/flow/Dockerfile
    depends_on:
      - postgres
    environment:
      DATABASE_URL: ${DATABASE_URL}
      PORT: ${FLOW_SERVICE_PORT}
    ports:
      - "${FLOW_SERVICE_PORT}:${FLOW_SERVICE_PORT}"
    networks:
      - tg-network

  codegen-service:
    build:
      context: .
      dockerfile: services/codegen/Dockerfile
    depends_on:
      - flow-service
    environment:
      PORT: ${CODEGEN_SERVICE_PORT}
    ports:
      - "${CODEGEN_SERVICE_PORT}:${CODEGEN_SERVICE_PORT}"
    networks:
      - tg-network

  gateway:
    build:
      context: .
      dockerfile: gateway/Dockerfile
    depends_on:
      - flow-service
    environment:
      FLOW_HOST: ${FLOW_HOST}
      FLOW_PORT: ${FLOW_SERVICE_PORT}
      GATEWAY_PORT: ${GATEWAY_PORT}
    ports:
      - "${GATEWAY_PORT}:${GATEWAY_PORT}"
    networks:
      - tg-network

  ui:
    build:
      context: .
      dockerfile: ui/Dockerfile
    depends_on:
      - gateway
      - flow-service
    environment:
      REACT_APP_GATEWAY_HOST: ${REACT_APP_GATEWAY_HOST}
      REACT_APP_GATEWAY_PORT: ${REACT_APP_GATEWAY_PORT}
    ports:
      - "${REACT_APP_UI_PORT}:${REACT_APP_UI_PORT}"
    networks:
      - tg-network

volumes:
  pgdata:

networks:
  tg-network:
    driver: bridge
